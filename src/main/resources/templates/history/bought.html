<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
  <meta charset="UTF-8">
  <title>êµ¬ë§¤ ë‚´ì—­ ìƒì„¸</title>
  <!-- í•„ìš”í•œ CSS, JS, CDN ë“± -->
  <link rel="stylesheet" href="/css/mypage.css">
  <style>
    .col-md-10 {
      padding-left: 80px;
      padding-top: 24px;
    }
    /* ìºëŸ¬ì…€ ì „ì²´ ì˜ì—­ ë° ê° ìŠ¬ë¼ì´ë“œì˜ ê³ ì • ë†’ì´ ì„¤ì • */
    .carousel-inner,
    .carousel-item {
      max-height: 400px;
      max-width: 400px;
    }
    /* ìºëŸ¬ì…€ ìŠ¬ë¼ì´ë“œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .carousel-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    /* ìŠ¤ë§ˆíŠ¸íƒë°° ë°°ì†¡ ì¡°íšŒ ë²„íŠ¼ */
    .smartapi-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      background-color: #17a2b8; /* íŒŒë€ìƒ‰ ê³„ì—´ì˜ ì •ë³´ìƒ‰ìƒ */
      color: white;
      font-size: 14px;
      cursor: pointer;
    }
    /* ê±°ë˜ ì™„ë£Œ ë²„íŠ¼ */
    .complete-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      background-color: #28a745;
      color: white;
      font-size: 14px;
      cursor: pointer;
      margin-right: 16px;
    }
    .complete-btn.completed {
      background-color: #ccc;
      color: #666;
      cursor: pointer;
      border: 1px solid #aaa;
    }
  </style>
</head>
<body>
<div class="container" layout:fragment="content">
  <div class="row">
    <!-- ì™¼ìª½ Sidebar (mypage ê·¸ëŒ€ë¡œ) -->
    <div class="sidebar" th:replace="~{mypage/mypage :: sidebar}"></div>
    <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì»¨í…ì¸  -->
    <div class="col-md-10">
      <h2 class="mb-4">êµ¬ë§¤ ë‚´ì—­ ìƒì„¸</h2>

      <!-- Section 1 -->
      <div class="card mb-4">
        <div class="card-header fw-bold">êµ¬ë§¤ ìƒí’ˆ ì •ë³´</div>
        <div class="card-body">
          <div class="row">
            <!-- ì™¼ìª½: ìƒí’ˆ ì •ë³´ -->
            <div class="col-md-7">
              <p><strong>ìƒí’ˆ ì´ë¦„:</strong> <span th:text="${boughtDetail.productName}">ìƒí’ˆ A</span></p>
              <p><strong>ê²½ë§¤ ì‹œì‘ê°€:</strong> <span th:text="${boughtDetail.startPrice}">10000</span></p>
              <p><strong>ë“±ë¡ ì‹œê°„:</strong> <span
                      th:text="${#temporals.format(boughtDetail.createdAt, 'yyyy-MM-dd HH:mm:ss')}">2025-02-05 14:30:00</span>
              </p>
              <p><strong>ê±°ë˜ ë°©ì‹:</strong> <span
                      th:text="${boughtDetail.dealType == 0 ? 'ğŸ§‘ğŸ» ì§ê±°ë˜' : (boughtDetail.dealType == 1 ? 'ğŸšš íƒë°°ê±°ë˜' : 'ğŸ§‘ğŸ»ğŸšš ì§ê±°ë˜, íƒë°°ê±°ë˜')}">ê±°ë˜ ë°©ì‹</span>
              </p>
              <hr/>
              <p><strong>íŒë§¤ì:</strong> <span th:text="${boughtDetail.sellerName}">íŒë§¤ì123</span></p>
              <p><strong>êµ¬ë§¤ê°€:</strong> <span th:text="${boughtDetail.totalPrice}">50,000 ì›</span></p>
              <p><strong>êµ¬ë§¤ ì‹œê°„:</strong> <span
                      th:text="${#temporals.format(boughtDetail.orderDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 16:45:00</span>
              </p>
              <p><strong>ê±°ë˜ ì™„ë£Œ ì‹œê°„:</strong> <span
                      th:text="${#temporals.format(boughtDetail.completedDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 17:00:00</span>
              </p>
            </div>
            <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì´ë¯¸ì§€ Carousel -->
            <div class="col-md-5">
              <div id="carouselSold" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                  <div th:each="image, iterStat : ${carouselImages}"
                       class="carousel-item"
                       th:classappend="${iterStat.index == 0} ? ' active' : ''">
                    <img th:src="@{${image.url}}" class="d-block w-100" th:alt="${image.alt}"/>
                  </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselSold"
                        data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">ì´ì „</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselSold"
                        data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">ë‹¤ìŒ</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2 -->
      <div class="card mb-4">
        <div class="card-header fw-bold">ë°°ì†¡ ìš”ì²­ ì •ë³´</div>
        <div class="card-body">
          <p><strong>ìˆ˜ë ¹ì¸ ì´ë¦„:</strong> <span th:text="${boughtDetail.recipientName}">í™ê¸¸ë™</span></p>
          <p><strong>ìˆ˜ë ¹ì¸ ì—°ë½ì²˜:</strong> <span th:text="${boughtDetail.recipientPhone}">010-1234-5678</span></p>
          <p><strong>ìš°í¸ë²ˆí˜¸:</strong> <span th:text="${boughtDetail.postalCode}">12345</span></p>
          <p><strong>ë°°ì†¡ ì£¼ì†Œ:</strong> <span th:text="${boughtDetail.deliveryAddress}">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123</span>
          </p>
          <!-- ìš´ì†¡ì¥ ë° ë°°ì†¡ ì¡°íšŒ ì˜ì—­ -->
          <div class="tracking mt-3 d-flex align-items-center">
            <span class="tracking-label fw-bold">ìš´ì†¡ì¥ ì •ë³´:</span>
            <button id="trackingBtn" class="btn btn-primary btn-sm ms-2" onclick="loadTracking()">ìš´ì†¡ì¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <span id="trackingText" class="ms-2 fw-bold" style="display: none;"></span>
            <button class="smartapi-btn ms-auto" onclick="">ë°°ì†¡ ì¡°íšŒ</button>
          </div>
        </div>
      </div>
      <!-- ê±°ë˜ ì™„ë£Œ ì˜ì—­ -->
      <div class="tracking-area d-flex">
        <button id="completeBtn" class="complete-btn ms-auto" onclick="completeTransaction()"
                th:classappend="${boughtDetail.completedDate != null} ? ' completed' : ''">ê±°ë˜ ì™„ë£Œ</button>
      </div>
    </div>
  </div>
</div>

<script layout:fragment="script" th:inline="javascript">

  let registeredTracking = /*[[${boughtDetail.deliveryStatus}]]*/ "";

  function loadTracking() {
    if (registeredTracking.trim() !== "") {
      document.getElementById("trackingBtn").style.display = "none"; // ë²„íŠ¼ ìˆ¨ê¹€
      const trackingText = document.getElementById("trackingText");
      trackingText.textContent = registeredTracking; // ìš´ì†¡ì¥ ë²ˆí˜¸ í‘œì‹œ
      trackingText.style.display = "inline"; // í…ìŠ¤íŠ¸ í‘œì‹œ
    } else {
      alert("ìš´ì†¡ì¥ ì •ë³´ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."); // ìš´ì†¡ì¥ ì •ë³´ê°€ ì—†ì„ ë•Œ ì•Œë¦¼
    }
  }

  function completeTransaction() {
    const completeBtn = document.getElementById("completeBtn");
    if (completeBtn.classList.contains("completed")) {
      alert("ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }

    if (!confirm("ì •ë§ ê±°ë˜ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      return;
    }

    const orderId = /*[[${boughtDetail.orderId}]]*/ 0;

    fetch('/history/bought/complete?orderId=' + orderId, {
      method: 'POST'
    })
            .then(response => response.text())
            .then(data => {
              if(data.trim() === "ì™„ë£Œ") {
                completeBtn.classList.add("completed");
                alert("ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
              } else {
                alert("ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            })
            .catch(error => {
              console.error("Error:", error);
              alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
  }

</script>
</body>
</html>
